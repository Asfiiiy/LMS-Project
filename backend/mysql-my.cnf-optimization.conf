# ================================
# MySQL 8.x Configuration
# LMS Production Optimization
# VPS: 8 vCPU / 32GB RAM / 400GB NVMe
# Users: 100k registered, 10k-15k active
# ================================
# 
# Installation:
# 1. Backup current config: sudo cp /etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/mysql.conf.d/mysqld.cnf.backup
# 2. Add these settings to: /etc/mysql/mysql.conf.d/mysqld.cnf
# 3. Restart MySQL: sudo systemctl restart mysql
# ================================

[mysqld]

# ================================
# InnoDB Settings (CRITICAL)
# ================================
# Buffer pool: 12GB (37.5% of 32GB RAM)
# This is the most important setting for performance
innodb_buffer_pool_size = 12G
innodb_buffer_pool_instances = 8  # Match vCPU count (8) for better concurrency

# InnoDB log files (requires MySQL restart)
innodb_log_file_size = 512M
innodb_log_buffer_size = 64M

# Performance & durability balance
# 2 = Write to OS cache, flush every second (good balance)
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# IO capacity for NVMe SSD
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# InnoDB read/write threads (optimized for 8 vCPU)
innodb_read_io_threads = 4
innodb_write_io_threads = 4

# ================================
# Connection Settings
# ================================
# IMPORTANT: max_connections must be >= DB_POOL_SIZE (250)
# Optimized for 10k-15k active users (100k registered)
max_connections = 300
max_user_connections = 250
max_connect_errors = 100000
thread_cache_size = 50
back_log = 300

# ================================
# Table & File Handling
# ================================
table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 65535

# ================================
# Temporary Tables
# ================================
tmp_table_size = 256M
max_heap_table_size = 256M

# ================================
# Query Cache (MySQL 8.0 removed, but kept for compatibility)
# ================================
# Note: Query cache removed in MySQL 8.0
# Use application-level caching (Redis) instead

# ================================
# Sort & Join Buffers
# ================================
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 2M
read_rnd_buffer_size = 4M

# ================================
# Network & Security
# ================================
# Skip DNS lookup (faster connections)
skip_name_resolve = 1

# Connection timeout
wait_timeout = 600
interactive_timeout = 600

# ================================
# Binary Logging (for replication, optional)
# ================================
# Uncomment if you need replication
# log_bin = /var/log/mysql/mysql-bin.log
# binlog_format = ROW
# expire_logs_days = 7
# max_binlog_size = 100M

# ================================
# Error Logging
# ================================
log_error = /var/log/mysql/error.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2  # Log queries taking more than 2 seconds

# ================================
# Character Set
# ================================
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci

# ================================
# Performance Schema (optional, can disable for small performance gain)
# ================================
# performance_schema = OFF

# ================================
# Additional Optimizations
# ================================
# Disable unused storage engines
# skip_federated
# skip_archive

# ================================
# NOTES
# ================================
# 1. After changing innodb_log_file_size, you may need to:
#    - Stop MySQL
#    - Remove old log files: sudo rm /var/lib/mysql/ib_logfile*
#    - Start MySQL (it will recreate them)
#
# 2. Monitor with: SHOW STATUS LIKE 'Threads_connected';
# 3. Check buffer pool usage: SHOW STATUS LIKE 'Innodb_buffer_pool%';
# 4. Monitor slow queries: tail -f /var/log/mysql/slow-query.log

